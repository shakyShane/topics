vars:
  - &root_dir            "."
  - &client_dir          "containers/www/client"
  - &client_env          ".env"
  - &client_env_template ".env.template"

commands:
  - &run-next-js
    title: Run's the NextJS application
    kind: Command
    cwd: *client_dir
    command: yarn start
  - &install-dependencies
    title: Run's the NextJS application
    kind: Command
    cwd: *client_dir
    command: yarn
  - &build-screenshot-images
    title: Builds just the images needed for screenshots
    kind: Command
    cwd: *root_dir
    command: skaffold build -b ncouk-disconnectedlayoutservice -b ncouk-client
  - &update-screen-shot-images
    title: Updates the screenshots images
    kind: Command
    cwd: *client_dir
    command: ./scripts/runScreenshotTests.sh dev:images
    examples: |
      Run screenshots again a single test/component
      ./scripts/runScreenshotTests.sh dev:images --only homepagelayout
  - &run-microservices
    title: Run all microservices via skaffold
    kind: Command
    cwd: *root_dir
    command: skaffold run

steps:
  - &env-file-exists
    kind: FileExistsCheck
    cwd: *client_dir
    path: *client_env
  - &kubernetes-installed
    kind: DependencyCheck
    verify: kubectl version -o json
    url: https://docs.docker.com/docker-for-mac/install
  - &helm-installed
    kind: DependencyCheck
    verify: helm version --short
    autofix: brew install helm
    url: https://helm.sh/
  - &skaffold-installed
    kind: DependencyCheck
    verify: skaffold version
    autofix: brew install skaffold
    url: https://skaffold.dev
  - &docker-installed
    kind: DependencyCheck
    verify: docker -v
    url: https://docs.docker.com/docker-for-mac/install/

multi_steps:
  - &kubernetes-deps
    kind: MultiSteps
    steps:
      - *docker-installed
      - *kubernetes-installed
      - *helm-installed
      - *skaffold-installed

topics:
  - name: "Run the frontend locally"
    steps:
      - *install-dependencies
      - *env-file-exists
      - *run-next-js
  - name: "Update screenshots"
    steps:
      - *kubernetes-deps
      - *build-screenshot-images
      - *update-screen-shot-images
  - name: "Run all microservices"
    steps:
      - *kubernetes-deps
      - *run-microservices
